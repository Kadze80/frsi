<?xml version="1.0" encoding="UTF-8"?>

<f:view
	encoding="UTF8"
	locale="#{facesContext.externalContext.requestLocale}"
	xmlns="http://www.w3.org/1999/xhtml"
	xmlns:c="http://java.sun.com/jsp/jstl/core"
	xmlns:f="http://java.sun.com/jsf/core"
	xmlns:h="http://java.sun.com/jsf/html"
    xmlns:ui="http://java.sun.com/jsf/facelets"
    xmlns:p="http://primefaces.org/ui"
    xmlns:components="http://java.sun.com/jsf/composite/components">

    <h:head>
        <link rel="stylesheet" type="text/css" href="/frsi-portlet/css/main.css?v=0.3"/>
        <link rel="stylesheet" type="text/css" href="/frsi-portlet/css/form.css?v=1.5"/>
        <link rel="stylesheet" type="text/css" href="/frsi-portlet/css/report_preview.css?v=0.2"/>
        <link rel="stylesheet" type="text/css" href="/frsi-portlet/css/picker.css?v=0.8"/>
        <script type="text/javascript" src="/frsi-portlet/js/autoNumeric.js"/>
        <script type="text/javascript" src="/frsi-portlet/js/datepicker-ru.js"/>
        <script type="text/javascript" src="/frsi-portlet/js/timepicker-ru.js"/>
        <script type="text/javascript" src="/frsi-portlet/js/jquery.scrollTo.min.js"/>
        <script type="text/javascript" src="/frsi-portlet/js/common.js"/>
        <script type="text/javascript" src="/frsi-portlet/js/main.js?v=0.3"/>
        <script type="text/javascript" src="/frsi-portlet/js/form.js?v=13"/>
        <script type="text/javascript" src="/frsi-portlet/js/custom-select.js?v=1.4"/>
        <script type="text/javascript" src="/frsi-portlet/js/tableHeadFixer.js?v=14.3"/>

        <script>
            function overlayPrintPreview(){
                var div = document.getElementById("dlgPrintPreview");
                if(div.style.visibility == "visible"){
                    div.style.visibility = "hidden";
                } else {
                    div.style.visibility = "visible";
                }
            }

            function overlayGalleriaPreview(){
                var div = document.getElementById("dlgGalleriaPreview");
                if(div.style.visibility == "visible"){
                    div.style.visibility = "hidden";
                } else {
                    div.style.visibility = "visible";
                }
            }

            function overlayGalleriaLetterPreview(){
                var div = document.getElementById("dlgGalleriaLetterPreview");
                if(div.style.visibility == "visible"){
                    div.style.visibility = "hidden";
                } else {
                    div.style.visibility = "visible";
                }
            }

            function overlayGalleriaWarrantPreview(){
                var div = document.getElementById("dlgGalleriaWarrantPreview");
                if(div.style.visibility == "visible"){
                    div.style.visibility = "hidden";
                } else {
                    div.style.visibility = "visible";
                }
            }
        </script>
    </h:head>

    <!-- Добавлен параметр для вьюшки reportId для корректной работы из нескольких вкладок.
    Также необходимо добавлять при необходимости в каждую кнопку дополнительный параметр reportId !!!!!-->

    <f:metadata>
        <f:viewParam name="reportId" value="#{reportBean.reportId}"/>
    </f:metadata>


    <h:body onload="updateLayout();textAreaAdjustAll();">
        <components:ajax-status/>
        <components:dialog-error id="ccDialogError"/>
        <h:form id="dynamic-form">
            <p:toolbar id="toolbar">
                <f:facet name="left">
                    <p:commandButton value="#{res.back}" action="/views/su/formdata/view?faces-redirect=true" icon="ui-icon-arrowreturn-1-w"/>
                    <span class="ui-separator"><span class="ui-icon ui-icon-grip-dotted-vertical"/></span>
                    <h:outputLabel value="Статус: #{reportBean.statusName}" style="font-weight: normal;" />
                    <span class="ui-separator"><span class="ui-icon ui-icon-grip-dotted-vertical"/></span>
                    <h:outputText value="&#160;&#160;&#160;&#160;" rendered="#{!reportBean.haveAttachedFile}"/>
                    <h:graphicImage url="/resources/icons16/paperclip.png" rendered="#{reportBean.haveAttachedFile}" style="position:relative; top:3px;" />
                    <h:outputText value="&#160;"/>
                    <h:graphicImage url="/resources/icons16/letter.png" rendered="#{reportBean.haveAttachedLetter}" style="position:relative; top:3px;" />
                    <span class="ui-separator"><span class="ui-icon ui-icon-grip-dotted-vertical"/></span>
                    <p:commandButton value="#{res.approve}" oncomplete="PF('wDlgConfirmApprove').show()" icon="ui-icon-check" disabled="#{reportBean.approved || !reportBean.rightApprove}" update=":frmConfirmApprove"/>
                    <p:commandButton value="#{res.disapprove}" oncomplete="PF('wDlgConfirmDisapprove').show()" icon="ui-icon-arrowreturnthick-1-s" disabled="#{!reportBean.approved || !reportBean.rightDisapprove}" update=":frmConfirmDisapprove"/>
                    <span class="ui-separator"><span class="ui-icon ui-icon-grip-dotted-vertical"/></span>
                    <p:selectBooleanButton title="Нажмите, чтобы зафиксировать или снять фиксацию с таблицы" offLabel="Зафиксировать" onLabel="Снять фиксацию" value="#{reportBean.fixed}" >
                        <p:ajax listener="#{reportBean.fixTable()}"/>
                    </p:selectBooleanButton>
                    <p:commandButton id="fix" oncomplete="fixTable(true,1)" style="display: none" />
                    <p:menuButton value="Просмотр">
                        <p:menuitem value="Статусы" actionListener="#{reportBean.refreshStatusesByReportId(reportBean.reportId, true)}"
                                    action="#{reportBean.setDraftStatusesHidden(true)}"
                                    oncomplete="PF('wDlgStatuses').show()" update=":frmStatuses"
                                    disabled="#{userBean.disabled(reportBean.reportId==null, 'SU:FORMS:HISTORY')}"
                                    title="История статусов" icon="ui-icon-script">
                            <f:param name="reportId" value="#{reportBean.reportId}"/>
                        </p:menuitem>
                        <p:menuitem value="Свойства" update=":frmReportProps" actionListener="#{reportBean.refreshProps(reportBean.reportId, true)}" oncomplete="PF('wDlgReportProps').show()"
                                    disabled="#{userBean.disabled(reportBean.reportId==null,'SU:FORMS:PROPS')}"
                                    title="Свойства выбранного отчёта" icon="ui-icon-tag">
                            <f:param name="reportId" value="#{reportBean.reportId}"/>
                        </p:menuitem>
                        <p:menuitem value="Версии отчета" update=":frmReportHistory"
                                    oncomplete="PF('wDlgReportHistory').show()"
                                    disabled="#{userBean.disabled(reportBean.reportId==null,'SU:FORMS:PROPS')}"
                                    action="#{reportBean.refreshReportHistoryItemList(reportBean.reportId)}" title="История отчёта"
                                    icon="ui-icon-clock">
                            <f:param name="reportId" value="#{reportBean.reportId}"/>
                        </p:menuitem>
                    </p:menuButton>
                    <p:menuButton value="Действия">
                        <p:menuitem value="Выгрузить в Excel" ajax="false" disabled="#{userBean.disabled(!reportBean.rightDonwload, 'SU:FORMS:DOWNLOAD_EXCEL')}"  icon="ui-icon-arrowthickstop-1-s">
                            <f:param name="reportId" value="#{reportBean.reportId}"/>
                            <p:fileDownload value="#{formDataBean.downloadSingleFile(null,reportBean.reportId)}"/>
                        </p:menuitem>
                        <p:menuitem value="Печать" actionListener="#{formDataBean.preparePdfFile(null, reportBean.reportId)}" oncomplete="if(!args.hasErrors) overlayPrintPreview();" update=":frmPrintPreview" disabled="#{userBean.disabled(false, 'SU:FORMS:PRINT')}"  icon="ui-icon-print">
                            <f:param name="reportId" value="#{reportBean.reportId}"/>
                        </p:menuitem>
                        <p:menuitem value="Контроль формы"
                                         actionListener="#{formDataBean.performControl(reportBean.reportId)}"
                                         update="messagesPanel" icon="ui-icon-gear"
                                         title="Логический контроль формы"
                                         oncomplete="PF('wLayoutMain').show('south');PF('wLayoutMain').layout.open('south');gotoPortletElement(':dynamic-form:groupControls', {offset: -80, axis: 'y'})">
                            <f:param name="reportId" value="#{reportBean.reportId}"/>
                        </p:menuitem>
                    </p:menuButton>
                    <p:menuButton value="Приложения">
                        <p:menuitem value="Пояснительная записка" title="Выгрузить пояснительную записку" rendered="#{reportBean.canAttachedFile}"
                                    actionListener="#{reportBean.refreshFileList(reportBean.reportId, null,'SU',1)}"
                                    oncomplete="PF('wDlgReportFile').show()" update=":frmReportFile"
                                    disabled="#{userBean.disabled(!reportBean.canAttachedFile, 'SU:FORMS:ATTACH_FILE')}">
                            <f:param name="reportId" value="#{reportBean.reportId}"/>
                        </p:menuitem>
                        <p:separator rendered="#{reportBean.canAttachedFile}"/>
                        <p:menuitem value="Сопроводительное письмо" title="Прикрепить сопроводительное письмо"
                                    actionListener="#{reportBean.refreshFileList(reportBean.reportId, null,'SU', 2)}"
                                    oncomplete="PF('wDlgReportLetter').show()" update=":frmReportLetter"
                                    disabled="#{!userBean.hasPermission('SU:FORMS:ATTACH_LETTER')}">
                        </p:menuitem>
                    </p:menuButton>
                </f:facet>
            </p:toolbar>
            <p:layout id="layoutMain" widgetVar="wLayoutMain" styleClass="layout-main" style="width: 100%; height: 320px;" resizeTitle="Переместить" expandTitle="Развернуть" collapseTitle="Свернуть" closeTitle="Закрыть">
                <p:layoutUnit id="luForm" position="center" styleClass="lu-form" style="width: 100%;">
                    <h:outputText value="#{reportBean.html}" escape="false"/>
                </p:layoutUnit>
                <p:layoutUnit id="luMessages" position="south" size="35%" resizable="true" closable="true" collapsible="true" collapsed="#{!formDataBean.validationVisible}" styleClass="lu-messages">
                    <f:facet name="header">
                        <h:outputText id="textMessages" value="Результаты контроля"/>
                    </f:facet>
                    <h:panelGroup id="messagesPanel">
                        <h:panelGroup id="groupControls" layout="block">
                            <h:panelGroup layout="block" style="width: 2.4em; float: left; margin-right: 0.5em">
                                <p:commandButton title="Печать" icon="ui-icon-print"
                                                 actionListener="#{formDataBean.prepareControlResultsPdfFile(null, reportBean.reportId)}"
                                                 oncomplete="if(!args.hasErrors) overlayPrintPreview();"
                                                 update=":frmPrintPreview">
                                    <f:param name="reportId" value="#{reportBean.reportId}"/>
                                </p:commandButton><br/>
                                <p:commandButton title="Выгрузить в Excel" ajax="false"
                                                 icon="ui-icon-arrowthickstop-1-s" style="margin-top: 3px">
                                    <p:fileDownload
                                            value="#{formDataBean.downloadControlResults(null, reportBean.reportId)}">
                                        <f:param name="reportId" value="#{reportBean.reportId}"/>
                                    </p:fileDownload>
                                </p:commandButton>
                            </h:panelGroup>
                            <p:dataTable id="tblControlResults" widgetVar="wTblControlResults"
                                         value="#{formDataBean.controlResults}" var="controlResult"
                                         rows="2147483647" resizableColumns="true" emptyMessage="#{res.noRecordsFound}"
                                         rowStyleClass="#{formDataBean.getControlRowStyleClass(controlResult.resultType)}">
                                <p:column headerText="Тип контроля" style="width: 15em" styleClass="wrap"><h:outputText
                                        value="#{controlResult.crosscheckTypeNameRu}"/></p:column>
                                <p:column headerText="Внешняя система" style="width: 10em"><h:outputText value="#{controlResult.externalSystemNameRu}"/></p:column>
                                <p:column headerText="#{res.expression}" styleClass="wrap"><h:outputText
                                        value="#{controlResult.descriptionRu}"/></p:column>
                                <p:column headerText="#{res.resultPerformControl}" style="width: 10em"
                                          styleClass="customColControlResult"><h:outputText
                                        value="#{reportsBean.getControlResultTypeName(controlResult.resultType)}"/></p:column>
                                <!--<p:column headerText="#{res.reportDate}" style="width:7em;text-align:center;">
                                    <h:outputText value="#{controlResult.reportDate}"><f:convertDateTime type="date"
                                                                                                         pattern="dd.MM.yyyy"/></h:outputText>
                                </p:column>-->
                            </p:dataTable>
                        </h:panelGroup>
                    </h:panelGroup>
                </p:layoutUnit>
            </p:layout>
        </h:form>

        <p:dialog header="Просмотр/выгрузка пояснительной записки" widgetVar="wDlgReportFile" modal="true" width="1000" height="420" resizable="false"  >
            <h:form id="frmReportFile">
                <h:panelGroup id="pgReportFile">
                    <p:toolbar>
                        <f:facet name="left">
                            <p:commandButton value="Обновить" title="Обновить список" actionListener="#{reportBean.refreshFileList(reportBean.reportId, null,'SU',1)}" update=":frmReportFile">
                                <f:param name="reportId" value="#{reportBean.reportId}"/>
                            </p:commandButton>
                            <p:separator/>
                            <p:commandButton value="Просмотреть" actionListener="#{reportBean.prepareGalleria(reportBean.reportId, reportBean.reportFileListItem, reportBean.selectedReportFileItem,1)}" disabled="#{reportBean.selectedReportFileItem == null}"
                                             oncomplete="if(!args.hasErrors) overlayGalleriaPreview();" update=":frmGalleriaPreview, :frmFooter"/>
                            <p:separator/>
                            <p:commandButton value="Выгрузить" title="Выгрузить записку" ajax="false" icon="ui-icon-arrowthickstop-1-s" disabled="#{reportBean.selectedReportFileItem == null}">
                                <p:fileDownload value="#{reportBean.onDownloadFile(reportBean.reportId,'SU',reportBean.selectedReportFileItem,1)}"/>
                                <f:param name="reportId" value="#{reportBean.reportId}"/>
                            </p:commandButton>
                        </f:facet>
                    </p:toolbar>
                </h:panelGroup>
                <p:dataTable id="t_reportFile" value="#{reportBean.reportFileListItem}" sortBy="#{reportFileItem.fileDate}" var="reportFileItem"  resizableColumns="true" selection="#{reportBean.selectedReportFileItem}" rowKey="#{reportFileItem}"
                             selectionMode="single" emptyMessage="#{res.noRecordsFound}" scrollable="true" scrollHeight="300" rows="2147483647">
                    <p:ajax event="rowSelect" update=":frmReportFile:pgReportFile" global="false"/>
                    <p:ajax event="rowUnselect" update=":frmReportFile:pgReportFile" global="false"/>
                    <p:ajax event="sort" global="false"/>
                    <p:column headerText="Наименование файла" sortBy="#{reportFileItem.fileName}" styleClass="wrap" style="width:40em"><h:outputText value="#{reportFileItem.fileName}"/></p:column>
                    <p:column headerText="Дата загрузки файла" sortBy="#{reportFileItem.fileDate}" style="width:15em"><h:outputText value="#{reportFileItem.fileDate}"><f:convertDateTime pattern="dd.MM.yyyy HH:mm:ss" /></h:outputText></p:column>
                    <p:column headerText="Пользователь, загрузивший файл" sortBy="#{reportFileItem.userName}" style="width:20em"><h:outputText value="#{reportFileItem.userName}"/></p:column>
                </p:dataTable>
                <br/>
                <p:commandButton value="#{res.close}" onclick="PF('wDlgReportFile').hide()" />
            </h:form>
        </p:dialog>

        <div id="dlgGalleriaPreview" class="customDialog ui-widget">
            <div class="customDialogContent">
                <div class="customDialogBody">
                    <h:form id="frmGalleriaPreview" style="width: 100%; height: 100%;">
                        <object id="objPdf" data="#{reportBean.curImage.path}" type="application/pdf" style="height: 100%; width: 100%;">
                            Возникла ошибка при отображении записки
                        </object>
                    </h:form>
                </div>
                <div class="customDialogFooter">
                    <h:form id="frmFooter">
                        <p style="position: absolute; left:0.5%; top: 40%;font-size: 11pt;">#{reportBean.curImage.title}</p>
                        <div style="position: absolute; left: 44%; top:10%">
                            <p:commandButton title="Первая" actionListener="#{reportBean.getCurObject('FIRST',reportBean.curImage,reportBean.imageList,1)}" icon="ui-icon-seek-prev" update=":frmGalleriaPreview,:frmFooter" disabled="#{reportBean.curImage.index == 0}"/>
                            <p:commandButton title="Предыдущая" actionListener="#{reportBean.getCurObject('PREV',reportBean.curImage,reportBean.imageList,1)}" icon="ui-icon-carat-1-w" update=":frmGalleriaPreview,:frmFooter" disabled="#{reportBean.curImage.index == 0}"/>
                        </div>
                        <div style="position: absolute; left: 49%; top: 15%;">
                            <p style="font-size: 11pt; font-weight: bold;">(#{reportBean.curImage.index+1}/#{reportBean.imageList.size()})</p>
                        </div>
                        <div style="position: absolute; left: 52%; top: 10%;">
                            <p:commandButton title="Следующая" actionListener="#{reportBean.getCurObject('NEXT',reportBean.curImage,reportBean.imageList,1)}" icon="ui-icon-carat-1-e" update=":frmGalleriaPreview,:frmFooter" disabled="#{reportBean.curImage.index == reportBean.imageList.size() - 1}" />
                            <p:commandButton title="Последняя" actionListener="#{reportBean.getCurObject('LAST',reportBean.curImage,reportBean.imageList,1)}" icon="ui-icon-seek-next" update=":frmGalleriaPreview,:frmFooter" disabled="#{reportBean.curImage.index == reportBean.imageList.size() - 1}" />
                        </div>
                        <button type="button" style="float: right" onclick="overlayGalleriaPreview();">Закрыть</button>
                    </h:form>
                </div>
            </div>
        </div>

        <p:dialog header="Просмотр/выгрузка сопроводительного письма" widgetVar="wDlgReportLetter" modal="true" width="1000" height="420" resizable="false" >
            <h:form id="frmReportLetter">
                <h:panelGroup id="pgReportLetter">
                    <p:toolbar>
                        <f:facet name="left">
                            <p:commandButton value="Обновить" title="Обновить список" actionListener="#{reportBean.refreshFileList(reportBean.reportId, null,'SU',2)}" update=":frmReportLetter">
                                <f:param name="reportId" value="#{reportBean.reportId}"/>
                            </p:commandButton>
                            <p:separator/>
                            <p:commandButton value="Просмотреть" actionListener="#{reportBean.prepareGalleria(reportBean.reportId, reportBean.reportLetterListItem, reportBean.selectedReportLetterItem,2)}" disabled="#{reportBean.selectedReportLetterItem == null}"
                                             oncomplete="if(!args.hasErrors) overlayGalleriaLetterPreview();" update=":frmGalleriaLetterPreview, :frmLetterFooter"/>
                            <p:separator/>
                            <p:commandButton value="Выгрузить" title="Выгрузить записку" ajax="false" icon="ui-icon-arrowthickstop-1-s" disabled="#{reportBean.selectedReportLetterItem == null}">
                                <p:fileDownload value="#{reportBean.onDownloadFile(reportBean.reportId,'SU', reportBean.selectedReportLetterItem,2)}"/>
                                <f:param name="reportId" value="#{reportBean.reportId}"/>
                            </p:commandButton>
                        </f:facet>
                    </p:toolbar>
                </h:panelGroup>
                <p:dataTable value="#{reportBean.reportLetterListItem}" sortBy="#{reportLetterItem.fileDate}" var="reportLetterItem"  resizableColumns="true" selection="#{reportBean.selectedReportLetterItem}"
                             rowKey="#{reportLetterItem}" selectionMode="single" emptyMessage="#{res.noRecordsFound}" scrollable="true" scrollHeight="300" rows="2147483647" >
                    <p:ajax event="rowSelect" update=":frmReportLetter:pgReportLetter" global="false"/>
                    <p:ajax event="rowUnselect" update=":frmReportLetter:pgReportLetter" global="false"/>
                    <p:ajax event="sort" global="false"/>
                    <p:column headerText="Наименование файла" sortBy="#{reportLetterItem.fileName}" styleClass="wrap" style="width:40em;" ><h:outputText value="#{reportLetterItem.fileName}"/></p:column>
                    <p:column headerText="Дата загрузки файла" sortBy="#{reportLetterItem.fileDate}" style="width:15em"><h:outputText value="#{reportLetterItem.fileDate}"><f:convertDateTime pattern="dd.MM.yyyy HH:mm:ss" /></h:outputText></p:column>
                    <p:column headerText="Пользователь, загрузивший файл" sortBy="#{reportLetterItem.userName}" style="width:20em"><h:outputText value="#{reportLetterItem.userName}"/></p:column>
                </p:dataTable>
                <br/>
                <p:commandButton value="#{res.close}" onclick="PF('wDlgReportLetter').hide()" />
                <br/>
            </h:form>
        </p:dialog>

        <div id="dlgGalleriaLetterPreview" class="customDialog ui-widget">
            <div class="customDialogContent">
                <div class="customDialogBody">
                    <h:form id="frmGalleriaLetterPreview" style="width: 100%; height: 100%;">
                        <object data="#{reportBean.curImageLetter.path}" type="application/pdf" style="height: 100%; width: 100%;">
                            Возникла ошибка при отображении записки
                        </object>
                    </h:form>
                </div>
                <div class="customDialogFooter">
                    <h:form id="frmLetterFooter">
                        <p style="position: absolute; left:0.5%; top: 40%;font-size: 11pt;">#{reportBean.curImageLetter.title}</p>
                        <div style="position: absolute; left: 44%; top:10%">
                            <p:commandButton title="Первая" actionListener="#{reportBean.getCurObject('FIRST', reportBean.curImageLetter,reportBean.imageLetterList,2)}" icon="ui-icon-seek-prev" update=":frmGalleriaLetterPreview,:frmLetterFooter" disabled="#{reportBean.curImageLetter.index == 0}"/>
                            <p:commandButton title="Предыдущая" actionListener="#{reportBean.getCurObject('PREV',reportBean.curImageLetter,reportBean.imageLetterList,2)}" icon="ui-icon-carat-1-w" update=":frmGalleriaLetterPreview,:frmLetterFooter" disabled="#{reportBean.curImageLetter.index == 0}"/>
                        </div>
                        <div style="position: absolute; left: 49%; top: 15%;">
                            <p style="font-size: 11pt; font-weight: bold;">(#{reportBean.curImageLetter.index+1}/#{reportBean.imageLetterList.size()})</p>
                        </div>
                        <div style="position: absolute; left: 52%; top: 10%;">
                            <p:commandButton title="Следующая" actionListener="#{reportBean.getCurObject('NEXT',reportBean.curImageLetter,reportBean.imageLetterList,2)}" icon="ui-icon-carat-1-e" update=":frmGalleriaLetterPreview,:frmLetterFooter" disabled="#{reportBean.curImageLetter.index == reportBean.imageLetterList.size() - 1}" />
                            <p:commandButton title="Последняя" actionListener="#{reportBean.getCurObject('LAST',reportBean.curImageLetter,reportBean.imageLetterList,2)}" icon="ui-icon-seek-next" update=":frmGalleriaLetterPreview,:frmLetterFooter" disabled="#{reportBean.curImageLetter.index == reportBean.imageLetterList.size() - 1}" />
                        </div>
                        <button type="button" style="float: right" onclick="overlayGalleriaLetterPreview();">Закрыть</button>
                    </h:form>
                </div>
            </div>
        </div>

        <div id="dlgGalleriaWarrantPreview" class="customDialog ui-widget">
            <div class="customDialogContent">
                <div class="customDialogBody">
                    <h:form id="frmGalleriaWarrantPreview" style="width: 100%; height: 100%;">
                        <object data="#{reportBean.curImageWarrant.path}" type="application/pdf" style="height: 100%; width: 100%;">
                            Возникла ошибка при отображении записки
                        </object>
                    </h:form>
                </div>
                <div class="customDialogFooter">
                    <h:form id="frmWarrantFooter">
                        <p style="position: absolute; left:0.5%; top: 40%;font-size: 11pt;">#{reportBean.curImageWarrant.title}</p>
                        <div style="position: absolute; left: 44%; top:10%">
                            <p:commandButton title="Первая" actionListener="#{reportBean.getCurObject('FIRST',reportBean.curImageWarrant,reportBean.imageWarrantList,1)}" icon="ui-icon-seek-prev" update=":frmGalleriaWarrantPreview,:frmWarrantFooter" disabled="#{reportBean.curImageWarrant.index == 0}"/>
                            <p:commandButton title="Предыдущая" actionListener="#{reportBean.getCurObject('PREV',reportBean.curImageWarrant,reportBean.imageWarrantList,1)}" icon="ui-icon-carat-1-w" update=":frmGalleriaWarrantPreview,:frmWarrantFooter" disabled="#{reportBean.curImageWarrant.index == 0}"/>
                        </div>
                        <div style="position: absolute; left: 49%; top: 15%;">
                            <p style="font-size: 11pt; font-weight: bold;">(#{reportBean.curImageWarrant.index+1}/#{reportBean.imageWarrantList.size()})</p>
                        </div>
                        <div style="position: absolute; left: 52%; top: 10%;">
                            <p:commandButton title="Следующая" actionListener="#{reportBean.getCurObject('NEXT',reportBean.curImageWarrant,reportBean.imageWarrantList,1)}" icon="ui-icon-carat-1-e" update=":frmGalleriaWarrantPreview,:frmWarrantFooter" disabled="#{reportBean.curImageWarrant.index == reportBean.imageWarrantList.size() - 1}" />
                            <p:commandButton title="Последняя" actionListener="#{reportBean.getCurObject('LAST',reportBean.curImageWarrant,reportBean.imageWarrantList,1)}" icon="ui-icon-seek-next" update=":frmGalleriaWarrantPreview,:frmWarrantFooter" disabled="#{reportBean.curImageWarrant.index == reportBean.imageWarrantList.size() - 1}" />
                        </div>
                        <button type="button" style="float: right" onclick="overlayGalleriaWarrantPreview();">Закрыть</button>
                    </h:form>
                </div>
            </div>
        </div>

        <h:form id="hidden" style="display: none;">
            <input type="button" value="Test" onclick="updateHiddenValue([{name:'tag', value: 'test'}]);" />
            <p:remoteCommand name="updateHiddenValue" actionListener="#{reportBean.hiddenListener}" oncomplete="onUpdateHiddenValue();" update=":hidden:hiddenValue" />
            <h:inputText id="hiddenValue" value="#{reportBean.hiddenValue}" style="width: 100%;" />
        </h:form>

        <p:dialog id="dlgOutputReports" widgetVar="wDlgOutputReports" header="Ошибка" modal="true" width="1024">
            <h:form id="frmOutputReports">
                <p:messages id="outputReportMessages" showDetail="true" autoUpdate="true" />
                <p:dataTable id="tblOutputReports" widgetVar="wTblOutputReports" value="#{formDataBean.outputReportList}"  var="outputReport"
                             rows="2147483647" scrollable="true" scrollHeight="320" resizableColumns="true" sortBy="#{outputReport.formName}" emptyMessage="#{res.noRecordsFound}">
                    <p:column headerText="Дата отчета" style="width:10em; text-align:center;"><h:outputText value="#{outputReport.reportDate}"><f:convertDateTime type="both" pattern="dd.MM.yyyy" /></h:outputText></p:column>
                    <p:column headerText="Название отчета"><h:outputText value="#{outputReport.formName}"/></p:column>
                    <p:column headerText="Тип отчета" style="width: 10em;text-align: left"><h:outputText value="#{outputReport.formTypeName}"/></p:column>
                    <p:column headerText="Статус" style="width: 10em;text-align:left;">
                        <h:outputText value="#{outputReport.statusName}"/>
                    </p:column>
                </p:dataTable>
                <p:commandButton type="button" value="Закрыть" onclick="PF('wDlgOutputReports').hide()" style="float: right"/>
            </h:form>
        </p:dialog>

        <h:form id="frmReportHistory">
            <p:dialog id="dlgReportHistory" widgetVar="wDlgReportHistory" header="Версии отчета" modal="true" width="1050">
                <p:toolbar id="tbReportHistory">
                    <f:facet name="left">
                        <p:commandButton id="btnOpenHistory" value="#{res.open}"
                                         action="#{formDataBean.openHistory(reportBean.selectedReportHistoryItem.id)}"
                                         disabled="#{reportBean.selectedReportHistoryItem==null}"
                                         title="Открыть выбранный отчёт" icon="ui-icon-document"/>
                        <p:commandButton id="btnEditComment" value="Комментарий"
                                         actionListener="#{reportBean.onOpenHistoryComment(reportBean.selectedReportHistoryItem.id)}"
                                         disabled="#{reportBean.selectedReportHistoryItem==null}"
                                         oncomplete="PF('wDlgHistoryComment').show();"
                                         update=":frmHistoryComment"
                                         title="Редактировать комментарий" icon="ui-icon-pencil"/>
                    </f:facet>
                </p:toolbar>
                <p:dataTable id="tblReportHistory" value="#{reportBean.reportHistoryListItems}"  var="reportHistory"
                             selectionMode="single" selection="#{reportBean.selectedReportHistoryItem}" rowKey="#{reportHistory}"
                             rows="2147483647" scrollable="true" scrollHeight="320" resizableColumns="true" emptyMessage="#{res.noRecordsFound}"
                             rowStyleClass="#{reportBean.getHistoryRowStyleClass(reportHistory)}">
                    <p:ajax event="rowSelect" update=":frmReportHistory:tbReportHistory"/>
                    <p:ajax event="rowUnselect" update=":frmReportHistory:tbReportHistory"/>
                    <p:column headerText="Дата отправки" style="width: 9em">
                        <h:outputText value="#{reportHistory.completeDate}"><f:convertDateTime type="both" pattern="dd.MM.yyyy HH:mm:ss" /></h:outputText>
                    </p:column>
                    <p:column headerText="Статус" style="width: 9em">
                        <h:outputText value="#{reportHistory.statusName}"/>
                        <h:panelGroup  rendered="#{reportHistory.current}"><br/><h:outputText value="(Текущая версия)"/></h:panelGroup>
                    </p:column>
                    <p:column headerText="Дата статуса" style="width: 9em">
                        <h:outputText value="#{reportHistory.statusDate}"><f:convertDateTime type="both" pattern="dd.MM.yyyy HH:mm:ss" /></h:outputText>
                    </p:column>
                    <p:column style="width:10em;text-align:center;" styleClass="customColControlResult">
                        <f:facet name="header">
                            <h:outputText value="Результат контроля" escape="false" style="white-space:pre-line;"/>
                        </f:facet>
                        <h:outputText value="#{reportHistory.controlResultName}"/>
                    </p:column>
                    <p:column headerText="Комментарий" style="width: 25em" styleClass="wrap">
                        <h:outputText value="#{reportHistory.comment}"/>
                    </p:column>
                </p:dataTable>
                <h:panelGroup style="float: right">
                    <p:commandButton type="button" value="Закрыть" onclick="PF('wDlgReportHistory').hide()"/>
                </h:panelGroup>
            </p:dialog>
        </h:form>

        <p:dialog id="dlgHistoryComment" widgetVar="wDlgHistoryComment" header="Окно для редактирования комментария" modal="true" resizable="false" width="600" >
            <h:form id="frmHistoryComment">
                <p:scrollPanel style="width: 580px;max-height: 320px" mode="native">
                    <p:inputTextarea value="#{reportBean.currentHistoryComment}" style="width: 555px;" maxlength="2000"/>
                </p:scrollPanel>
                <br/>
                <p:commandButton value="#{res.save}" actionListener="#{reportBean.editHistoryComment(reportBean.selectedReportHistoryItem.id)}" oncomplete="PF('wDlgHistoryComment').hide()"
                                 update=":frmReportHistory:tblReportHistory" />
                &#160;
                <p:commandButton value="#{res.clear}" actionListener="#{reportBean.clearHistoryComment()}" update="frmHistoryComment"/>
                &#160;
                <p:commandButton type="button" value="#{res.cancel}" onclick="PF('wDlgHistoryComment').hide()"/>
            </h:form>
        </p:dialog>

        <p:dialog id="dlgStatuses" widgetVar="wDlgStatuses" header="История статусов" modal="true" width="1000" height="600">
            <h:form id="frmStatuses">
                <table style="border-collapse:collapse; border-style:none; width:100%;">
                    <tr>
                        <td><h:outputText value="Количество отправок: #{reportBean.sendCount}"/></td>
                        <td style="width:auto; text-align:right; vertical-align:middle;">
                            <p:selectBooleanCheckbox id="globalFilter" value="#{reportBean.draftStatusesHidden}" style="vertical-align:-0.25em;">
                                <!--<p:ajax oncomplete="PF('wTblStatuses').filter()"/>-->
                                <p:ajax listener="#{reportBean.refreshStatusesByReportId(reportBean.reportId, true)}" update="tblStatuses">
                                    <f:param name="reportId" value="#{reportBean.reportId}"/>
                                </p:ajax>
                            </p:selectBooleanCheckbox>&#160;&#160;&#160;&#160;
                            <h:outputText value="Скрыть &#171;черновики&#187;"/>
                        </td>
                    </tr>
                </table><br/>
                <p:dataTable id="tblStatuses" widgetVar="wTblStatuses" lazy="true" value="#{reportBean.ldmReportStatus}" filteredValue="#{reportBean.filteredStatuses}" var="status"
                             rows="2147483647" scrollable="true" scrollHeight="480" resizableColumns="true"
                             sortBy="#{status.statusDate}" emptyMessage="#{res.noRecordsFound}" style="width:99%">
                    <p:column headerText="Статус" filterBy="#{status.statusName}" filterStyle="display:none" style="width:12em;"><h:outputText value="#{status.getStatusName('ru')}"/></p:column>
                    <p:column headerText="Дата изменения" style="width:10em; text-align:center;"><h:outputText value="#{status.statusDate}"><f:convertDateTime type="both" pattern="dd.MM.yyyy HH:mm:ss"/></h:outputText></p:column>
                    <p:column headerText="#{res.comment}" styleClass="wrap">
                        <h:outputText value="#{status.message}"/>&#160;&#160;&#160;&#160;
                        <p:commandButton icon="ui-icon-document" actionListener="#{reportBean.prepareWarrantGalleriaByStatus(formDataBean.selectedReportListItem.id, status)}" rendered="#{status.haveUserWarrant || status.haveRespWarrant}"
                                         title="Просмотр прикрепленной доверенности"
                                         oncomplete="if(!args.hasErrors) overlayGalleriaWarrantPreview();" update=":frmGalleriaWarrantPreview, :frmWarrantFooter">
                            <f:setPropertyActionListener value="#{status}" target="#{formDataBean.selectedStatus}" />
                        </p:commandButton>
                    </p:column>
                </p:dataTable>
                <br/>
                <p:commandButton type="button" value="#{res.close}" onclick="PF('wDlgStatuses').hide()" />
                <br/>
            </h:form>
        </p:dialog>

        <p:dialog id="dlgReportProps" widgetVar="wDlgReportProps" header="Свойства отчёта" modal="true" width="600" height="250">
            <h:form id="frmReportProps">
                <h:outputText value="Наименование:&#160;&#160;&#160;&#160;" style="font-weight:bold"/>
                <h:outputText value="#{reportBean.formName}"/><br/><br/>
                <h:outputText value="Отчетная дата:&#160;&#160;&#160;&#160;" style="font-weight:bold"/>
                <h:outputText value="#{formDataBean.selectedReportListItem.reportDate}"><f:convertDateTime type="date" pattern="dd.MM.yyyy"/></h:outputText><br/>
                <h:outputText value="Код:&#160;&#160;&#160;&#160;" style="font-weight:bold"/>
                <h:outputText value="#{reportBean.formCode}"/><br/>
                <h:outputText value="Дата последнего изменения:&#160;&#160;&#160;&#160;" style="font-weight:bold"/>
                <h:outputText value="#{reportBean.saveDate}"><f:convertDateTime type="both" pattern="dd.MM.yyyy HH:mm:ss"/></h:outputText><br/>
                <h:outputText value="Статус:&#160;&#160;&#160;&#160;" style="font-weight:bold"/>
                <h:outputText value="#{reportBean.statusName}"/><br/>
                <h:outputText value="Дата последнего изменения статуса:&#160;&#160;&#160;&#160;" style="font-weight:bold"/>
                <h:outputText value="#{reportBean.statusDate}"><f:convertDateTime type="both" pattern="dd.MM.yyyy HH:mm:ss"/></h:outputText><br/>
                <h:outputText value="Подписи:&#160;&#160;&#160;&#160;" style="font-weight:bold"/><br/>
                <ui:repeat value="#{reportBean.signeInfos}" var="signInfo">
                    <h:outputText value="#{signInfo.refPostItem.nameRu}:&#160;&#160;&#160;&#160;" style="font-weight:bold"/>
                    <h:outputText value="#{signInfo.info}"/><br/>
                </ui:repeat>
                <br/>
                <p:commandButton type="button" value="#{res.close}" onclick="PF('wDlgReportProps').hide()" />
                <br/>
            </h:form>
        </p:dialog>

        <h:form id="frmConfirmApprove">
            <p:confirmDialog id="dlgConfirmApprove" widgetVar="wDlgConfirmApprove" message="Вы уверены, что хотите утвердить входную форму?" header="#{res.approval}" severity="alert">
                <h:form>
                    <p:selectBooleanCheckbox value="#{formDataBean.editNoticeText}"/>
                    <h:outputLabel value="Дополнить текст уведомления" style="font-weight:bold;" />
                    <br/><br/>
                    <p:commandButton value="#{res.approve}" actionListener="#{formDataBean.approveAndUpdate(null,reportBean.reportId)}">
                        <f:param name="reportId" value="#{reportBean.reportId}"/>
                    </p:commandButton>
                    <p:commandButton value="#{res.cancel}" onclick="PF('wDlgConfirmApprove').hide()"/>
                </h:form>
            </p:confirmDialog>
        </h:form>

        <h:form id="frmConfirmDisapprove">
            <p:confirmDialog id="dlgConfirmDisapprove" widgetVar="wDlgConfirmDisapprove" message="Вы уверены, что хотите разутвердить входную форму?" header="#{res.disapproval}" severity="alert">
                <h:form>
                    <p:selectBooleanCheckbox value="#{formDataBean.editNoticeText}"/>
                    <h:outputLabel value="Дополнить текст уведомления" style="font-weight:bold;" />
                    <br/><br/>
                    <p:commandButton value="#{res.disapprove}" actionListener="#{formDataBean.disapproveAndUpdate(null,reportBean.reportId)}">
                        <f:param name="reportId" value="#{reportBean.reportId}"/>
                    </p:commandButton>
                    <p:commandButton value="#{res.cancel}" onclick="PF('wDlgConfirmDisapprove').hide()"/>
                </h:form>
            </p:confirmDialog>
        </h:form>

        <p:dialog id="dlgMessage" widgetVar="wDlgMessage" header="Шаблон сообщения" modal="true" resizable="false" width="740" height="500">
            <h:form id="frmMessage">
                <p:inputTextarea value="#{formDataBean.noticeMessage}" style="width: 700px; min-height: 450px" maxlength="2048" />

                <p:commandButton value="Ok" actionListener="#{formDataBean.onDlgMessageHideFromForm}" oncomplete="PF('wDlgMessage').hide()" style="margin-top: 5px" />
                &#160;&#160;&#160;&#160;&#160;&#160;
                <p:commandButton value="Переменные" actionListener="#{formDataBean.onDlgVariableShow}" oncomplete="PF('wDlgVariable').show()" update=":frmVariable" style="margin-top: 5px" />
            </h:form>
        </p:dialog>

        <p:dialog id="dlgVariable" widgetVar="wDlgVariable" header="Выбор переменной" modal="true" resizable="false" width="740" height="300">
            <h:form id="frmVariable">
                <p:dataTable value="#{formDataBean.variableList}" var="variable"
                             rowKey="#{variable.id}" sortBy="#{variable.getName()}" scrollable="true" scrollHeight="240"
                             emptyMessage="#{res.noRecordsFound}" >
                    <p:column headerText="Название" sortBy="#{variable.name}"><h:outputText value="#{variable.name}"/></p:column>
                    <p:column headerText="Код" sortBy="#{variable.code}"><h:outputText value="#{variable.code}"/></p:column>
                </p:dataTable>

                <p:commandButton value="#{res.close}" type="button" onclick="PF('wDlgVariable').hide()" />
            </h:form>
        </p:dialog>

        <!--<components:dialog-pick-bank id="ccDialogPickBank" update="@all"/>-->
        <components:dialog-pick-issuer id="ccDialogPickIssuer" update="@all"/>
        <components:dialog-pick-security id="ccDialogPickSecurity" update="@all"/>
        <components:dialog-pick-securityinfo id="ccDialogPickSecurityInfo" update="@all"/>
        <!--<components:dialog-pick-lp id="ccDialogPickLegalPerson" update="@all"/>-->
        <!--<components:dialog-pick-person id="ccDialogPickPerson" update="@all"/>-->

        <components:pick-bank id="ccPickBank" update="@all"/>
        <components:pick-person id="ccPickPerson" update="@all"/>
        <components:pick-legal-person id="ccPickLegalPerson" update="@all"/>

        <div id="ref_template_multiple" class="m-dialog">
            <div class="m-dialog-content">
                <div class="dialog-body">
                    <table class="data-table">
                    </table>
                </div>
                <div class="m-dialog-footer">
                    <button class="m-dialog-select-button" value="Select" disabled="disabled">Выбрать</button>
                    <button class="m-dialog-cancel-button" value="Cancel">Отмена</button>
                </div>
            </div>
        </div>
        <div id="ref_template_single" class="s-dialog">
            <div class="s-dialog-content">
                <div class="dialog-body">
                    <table class="data-table">
                    </table>
                </div>
            </div>
        </div>

        <div id="dlgPrintPreview" class="customDialog ui-widget">
            <div class="customDialogContent">
                <div class="customDialogBody">
                    <h:form id="frmPrintPreview" style="width: 100%; height: 100%">
                        <object data="#{formDataBean.pdfFilePath}" type="application/pdf"
                                style="width: 100%; height: 100%"
                                id="pdfDocument">
                            Возникла ошибка при печати
                        </object>
                    </h:form>
                </div>
                <div class="customDialogFooter">
                    <button class="customDialogCloseButton" onclick="overlayPrintPreview();">Закрыть</button>
                </div>
            </div>
        </div>
    </h:body>
</f:view>